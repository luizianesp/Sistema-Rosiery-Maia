{% load static %}
{% block title %}Gerenciar Projetos{% endblock title %}

{% block content %}
<div class="content-area">
  <h1>Gerenciar Projetos</h1>
  <p class="lead">Aqui você pode visualizar, adicionar, editar ou remover projetos.</p>

  <div class="mb-3">
    <button type="button" class="btn btn-primary" id="addProjectBtn"
      style="background-color: var(--accent-color); border-color: var(--accent-color); color: white;">
      <i class="fas fa-plus-circle me-2"></i>Adicionar Novo Projeto
    </button>
  </div>

  <div class="card p-4 shadow-sm mb-4" id="projectFormCard" style="display: none;">
    <h5><span id="formTitle">Adicionar</span> Projeto</h5>
    <form id="projectForm" enctype="multipart/form-data">
      {% csrf_token %}
      <input type="hidden" id="projectId">

      <div class="mb-3">
        <label for="titulo" class="form-label">Título</label>
        <input type="text" class="form-control" id="titulo" name="titulo" required>
      </div>
      <div class="mb-3">
        <label for="descricao" class="form-label">Descrição</label>
        <textarea class="form-control" id="descricao" name="descricao" rows="3" required></textarea>
      </div>
      <div class="mb-3">
        <label for="imagem" class="form-label">Imagem do Projeto</label>
        <input type="file" class="form-control" id="imagem" name="imagem" accept="image/*">
        <small class="form-text text-muted" id="currentImageDisplay"></small>
      </div>
      <div class="mb-3">
        <label for="categoria" class="form-label">Categoria</label>
        <select class="form-select" id="categoria" name="categoria" required>
          <option value="">Selecione a Categoria</option>
          <option value="Pesquisa">Pesquisa</option>
          <option value="Ensino">Ensino</option>
          <option value="Extensão">Extensão</option>
        </select>
      </div>
      <div class="mb-3">
        <label for="financiamento" class="form-label">Financiamento</label>
        <input type="text" class="form-control" id="financiamento" name="financiamento">
      </div>
      <div class="mb-3">
        <label for="equipe" class="form-label">Equipe</label>
        <textarea class="form-control" id="equipe" name="equipe" rows="2"></textarea>
      </div>

      <button type="submit" class="btn btn-primary"
        style="background-color: var(--accent-color); border-color: var(--accent-color); color: white;">
        <i class="fas fa-save me-2"></i>Salvar Projeto
      </button>
      <button type="button" class="btn btn-secondary ms-2" id="cancelFormBtn">Cancelar</button>
    </form>
    <div id="form-feedback" class="mt-3" style="display: none;"></div>
  </div>

  <div class="card p-3 shadow-sm">
    <h5>Projetos Atuais</h5>
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th>ID</th>
            <th>Título</th>
            <th>Categoria</th>
            <th>Financiamento</th>
            <th>Imagem</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="projectsTableBody">
          <tr><td colspan="6" class="text-center">Carregando projetos...</td></tr>
        </tbody>
      </table>
    </div>
    <div id="table-feedback" class="mt-3" style="display: none;"></div>
  </div>
</div>

<script>
(function () {
  const apiUrl = '/api/projetos/';
  const projectForm = document.getElementById('projectForm');
  const formTitle = document.getElementById('formTitle');
  const projectFormCard = document.getElementById('projectFormCard');
  const projectsTableBody = document.getElementById('projectsTableBody');
  const feedback = document.getElementById('form-feedback');
  const tableFeedback = document.getElementById('table-feedback');
  const cancelBtn = document.getElementById('cancelFormBtn');
  const addBtn = document.getElementById('addProjectBtn');

  const titulo = document.getElementById('titulo');
  const descricao = document.getElementById('descricao');
  const imagem = document.getElementById('imagem');
  const categoria = document.getElementById('categoria');
  const financiamento = document.getElementById('financiamento');
  const equipe = document.getElementById('equipe');
  const currentImageDisplay = document.getElementById('currentImageDisplay');
  const projectId = document.getElementById('projectId');

  let currentEditId = null;

  function getCSRF() {
    const token = document.querySelector('[name=csrfmiddlewaretoken]');
    return token ? token.value : '';
  }

  function showFeedback(el, msg, type = 'info') {
    el.className = `alert alert-${type}`;
    el.innerText = msg;
    el.style.display = 'block';
    setTimeout(() => el.style.display = 'none', 4000);
  }

  function clearForm() {
    projectForm.reset();
    currentEditId = null;
    projectId.value = '';
    formTitle.innerText = 'Adicionar';
    projectFormCard.style.display = 'none';
    currentImageDisplay.innerHTML = '';
  }

  async function fetchProjects() {
    projectsTableBody.innerHTML = '<tr><td colspan="6" class="text-center">Carregando...</td></tr>';
    const res = await fetch(apiUrl);
    const data = await res.json();
    projectsTableBody.innerHTML = '';
    if (data.length === 0) {
      projectsTableBody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhum projeto encontrado.</td></tr>';
      return;
    }
    data.forEach(p => {
      const imgTag = p.imagem ? `<img src="${p.imagem}" style="height:40px;">` : '—';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${p.id}</td>
        <td>${p.titulo}</td>
        <td>${p.categoria}</td>
        <td>${p.financiamento || '—'}</td>
        <td>${imgTag}</td>
        <td>
          <button class="btn btn-sm btn-info me-2 edit-btn" data-id="${p.id}">Editar</button>
          <button class="btn btn-sm btn-danger delete-btn" data-id="${p.id}">Remover</button>
        </td>`;
      projectsTableBody.appendChild(tr);
    });

    document.querySelectorAll('.edit-btn').forEach(btn =>
      btn.addEventListener('click', () => handleEdit(btn.dataset.id)));
    document.querySelectorAll('.delete-btn').forEach(btn =>
      btn.addEventListener('click', () => handleDelete(btn.dataset.id)));
  }

  async function handleEdit(id) {
    const res = await fetch(apiUrl + id);
    const p = await res.json();
    titulo.value = p.titulo;
    descricao.value = p.descricao;
    categoria.value = p.categoria;
    financiamento.value = p.financiamento || '';
    equipe.value = p.equipe || '';
    projectId.value = p.id;
    currentEditId = p.id;
    currentImageDisplay.innerHTML = p.imagem ? `<img src="${p.imagem}" style="max-height:50px;">` : '';
    formTitle.innerText = 'Editar';
    projectFormCard.style.display = 'block';
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  async function handleDelete(id) {
    if (!confirm('Tem certeza que deseja excluir?')) return;
    const res = await fetch(apiUrl + id, {
      method: 'DELETE',
      headers: { 'X-CSRFToken': getCSRF() }
    });
    if (res.ok) {
      showFeedback(tableFeedback, 'Projeto removido com sucesso!', 'success');
      fetchProjects();
    }
  }

  projectForm.addEventListener('submit', async e => {
    e.preventDefault();
    const formData = new FormData();
    formData.append('titulo', titulo.value);
    formData.append('descricao', descricao.value);
    formData.append('categoria', categoria.value);
    formData.append('financiamento', financiamento.value);
    formData.append('equipe', equipe.value);
    if (imagem.files.length > 0) formData.append('imagem', imagem.files[0]);
    formData.append('csrfmiddlewaretoken', getCSRF());

    const url = currentEditId ? apiUrl + currentEditId : apiUrl;
    const method = currentEditId ? 'PUT' : 'POST';

    const res = await fetch(url, {
      method,
      headers: { 'X-CSRFToken': getCSRF() },
      body: formData
    });

    if (res.ok) {
      const p = await res.json();
      showFeedback(feedback, 'Projeto salvo com sucesso!', 'success');
      clearForm();
      fetchProjects();
    } else {
      const err = await res.json().catch(() => ({}));
      showFeedback(feedback, err.detail || 'Erro ao salvar projeto.', 'danger');
    }
  });

  addBtn.addEventListener('click', () => {
    clearForm();
    projectFormCard.style.display = 'block';
    titulo.focus();
  });

  cancelBtn.addEventListener('click', clearForm);

  fetchProjects();
})();
</script>

{% endblock content %}