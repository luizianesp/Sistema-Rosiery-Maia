{% load static %}
{% block title %}Gerenciar Áreas de Pesquisa{% endblock title %}

{% block content %}
<div class="content-area">
    <h1>Gerenciar Áreas de Pesquisa</h1>
    <p class="lead">Aqui você pode adicionar, editar ou remover áreas de pesquisa do site.</p>

    <div class="mb-3">
        <button type="button" class="btn btn-primary me-2"
                style="background-color: var(--accent-color); border-color: var(--accent-color); color: white;"
                id="addAreaBtn">
            <i class="fas fa-plus-circle me-2"></i>Adicionar Nova Área
        </button>
    </div>

    <div class="card p-4 shadow-sm mb-4" id="areaFormCard" style="display: none;">
        <h5><span id="formTitle">Adicionar</span> Área de Pesquisa</h5>
        <form id="areaForm">
            {% csrf_token %}
            <input type="hidden" id="areaId">

            <div class="mb-3">
                <label for="nome" class="form-label">Nome da Área</label>
                <input type="text" class="form-control" id="nome" name="nome" required>
            </div>
            <div class="mb-3">
                <label for="descricao" class="form-label">Descrição (Opcional)</label>
                <textarea class="form-control" id="descricao" name="descricao" rows="3"></textarea>
            </div>

            <div class="mb-3">
                <label for="topicosSelect" class="form-label">Tópicos (Selecione um ou mais)</label>
                <select class="form-select" id="topicosSelect" name="topicos_ids" multiple>
                </select>
                <small class="form-text text-muted">Use Ctrl/Cmd + clique para selecionar múltiplos.</small>
            </div>

            <button type="submit" class="btn btn-success"
                    style="background-color: var(--accent-color); border-color: var(--accent-color); color: white;">
                <i class="fas fa-save me-2"></i>Salvar Área
            </button>
            <button type="button" class="btn btn-secondary ms-2" id="cancelFormBtn">Cancelar</button>
        </form>
        <div id="form-feedback" class="mt-3" style="display: none;"></div>
    </div>

    <div class="card p-3 shadow-sm">
        <h5>Áreas de Pesquisa Atuais</h5>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nome</th>
                        <th>Descrição</th>
                        <th>Tópicos</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="areasTableBody">
                    <tr><td colspan="5" class="text-center">Carregando áreas de pesquisa...</td></tr>
                </tbody>
            </table>
        </div>
        <div id="table-feedback" class="mt-3" style="display: none;"></div>
    </div>
</div>

<script>
(function () {
    console.log('[Script Áreas de Pesquisa] Script iniciado.');

    const areasApiUrl = '/api/areas/';
    const topicosApiUrl = '/api/areas/topicos/';
    const areasTableBody = document.getElementById('areasTableBody');
    const addAreaBtn = document.getElementById('addAreaBtn');
    const areaFormCard = document.getElementById('areaFormCard');
    const areaForm = document.getElementById('areaForm');
    const formTitle = document.getElementById('formTitle');
    const areaIdInput = document.getElementById('areaId');
    const cancelFormBtn = document.getElementById('cancelFormBtn');
    const formFeedback = document.getElementById('form-feedback');
    const tableFeedback = document.getElementById('table-feedback');
    const nomeInput = document.getElementById('nome');
    const descricaoInput = document.getElementById('descricao');
    const topicosSelect = document.getElementById('topicosSelect');
    let currentEditId = null;
    let allTopicos = [];

    function getCsrfToken() {
        const csrfElement = document.querySelector('input[name="csrfmiddlewaretoken"]');
        return csrfElement ? csrfElement.value : '';
    }

    function showFeedback(element, message, type = 'info') {
        element.textContent = message;
        element.className = `alert alert-${type}`;
        element.style.display = 'block';
        setTimeout(() => {
            element.style.display = 'none';
        }, 5000);
    }

    function clearForm() {
        areaForm.reset();
        areaIdInput.value = '';
        currentEditId = null;
        formTitle.textContent = 'Adicionar';
        areaFormCard.style.display = 'none';
        formFeedback.style.display = 'none';
        tableFeedback.style.display = 'none';
        Array.from(topicosSelect.options).forEach(option => option.selected = false);
    }

    async function fetchAndPopulateTopicos() {
        try {
            const response = await fetch(topicosApiUrl);
            if (!response.ok) throw new Error('Erro ao buscar tópicos.');
            allTopicos = await response.json();
            topicosSelect.innerHTML = '';
            allTopicos.forEach(topico => {
                const option = document.createElement('option');
                option.value = topico.id;
                option.textContent = topico.nome;
                topicosSelect.appendChild(option);
            });
        } catch (error) {
            showFeedback(tableFeedback, `Erro ao carregar tópicos: ${error.message}`, 'danger');
        }
    }

    async function fetchAreas() {
        areasTableBody.innerHTML = '<tr><td colspan="5" class="text-center">Carregando...</td></tr>';
        try {
            const response = await fetch(areasApiUrl);
            const areas = await response.json();
            renderAreasTable(areas);
        } catch (error) {
            areasTableBody.innerHTML = '<tr><td colspan="5" class="text-danger text-center">Erro ao carregar.</td></tr>';
        }
    }

    function renderAreasTable(areas) {
        areasTableBody.innerHTML = '';
        if (areas.length === 0) {
            areasTableBody.innerHTML = '<tr><td colspan="5" class="text-center">Nenhuma área encontrada.</td></tr>';
            return;
        }
        areas.forEach(area => {
            const topicosNomes = area.topico?.map(t => t.nome).join(', ') || 'N/A';
            const row = areasTableBody.insertRow();
            row.innerHTML = `
                <td>${area.id}</td>
                <td>${area.nome}</td>
                <td>${area.descricao || 'N/A'}</td>
                <td>${topicosNomes}</td>
                <td>
                    <button class="btn btn-info btn-sm me-2 edit-btn" data-id="${area.id}">Editar</button>
                    <button class="btn btn-danger btn-sm delete-btn" data-id="${area.id}">Remover</button>
                </td>
            `;
        });
        document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', handleEdit));
        document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', handleDelete));
    }

    if (addAreaBtn) addAreaBtn.addEventListener('click', () => {
        clearForm();
        areaFormCard.style.display = 'block';
        nomeInput.focus();
    });

    if (cancelFormBtn) cancelFormBtn.addEventListener('click', clearForm);

    if (areaForm) {
        areaForm.addEventListener('submit', async function (event) {
            event.preventDefault();
            const selectedTopicosIds = Array.from(topicosSelect.selectedOptions).map(opt => parseInt(opt.value));
            const formData = {
                nome: nomeInput.value,
                descricao: descricaoInput.value || null,
                topicos_ids: selectedTopicosIds
            };
            const csrfToken = getCsrfToken();
            let method = currentEditId ? 'PUT' : 'POST';
            let url = currentEditId ? `${areasApiUrl}${currentEditId}` : areasApiUrl;

            try {
                showFeedback(formFeedback, 'Salvando...', 'info');
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(formData)
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.detail || 'Erro ao salvar.');
                showFeedback(formFeedback, 'Salvo com sucesso!', 'success');
                clearForm();
                fetchAreas();
            } catch (error) {
                showFeedback(formFeedback, `Erro: ${error.message}`, 'danger');
            }
        });
    }

    async function handleEdit(event) {
        const id = event.target.dataset.id;
        const response = await fetch(`${areasApiUrl}${id}`);
        const area = await response.json();
        nomeInput.value = area.nome;
        descricaoInput.value = area.descricao || '';
        Array.from(topicosSelect.options).forEach(opt => {
            opt.selected = area.topico.some(t => t.id === parseInt(opt.value));
        });
        areaIdInput.value = area.id;
        currentEditId = area.id;
        formTitle.textContent = 'Editar';
        areaFormCard.style.display = 'block';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function handleDelete(event) {
        const id = event.target.dataset.id;
        if (!confirm('Tem certeza que deseja excluir?')) return;
        try {
            const csrfToken = getCsrfToken();
            const response = await fetch(`${areasApiUrl}${id}`, {
                method: 'DELETE',
                headers: { 'X-CSRFToken': csrfToken }
            });
            if (!response.ok) throw new Error('Erro ao remover.');
            showFeedback(tableFeedback, 'Removido com sucesso!', 'success');
            fetchAreas();
        } catch (error) {
            showFeedback(tableFeedback, `Erro: ${error.message}`, 'danger');
        }
    }

    fetchAndPopulateTopicos().then(fetchAreas);
})();
</script>
{% endblock content %}
