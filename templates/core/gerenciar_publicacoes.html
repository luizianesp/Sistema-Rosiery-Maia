{% block content %}
<div class="content-area">
{#    <p style="color: red; font-weight: bold;">TESTE DE CARREGAMENTO: Se vir isto, o ficheiro foi encontrado!</p>#}
    <h1>Gerenciar Publicações</h1>
    <p class="lead">Aqui você pode adicionar, editar ou remover publicações do site.</p>

    <!-- Botões de Ação -->
    <div class="mb-3">
        <button type="button" class="btn btn-primary me-2" style="background-color: var(--accent-color); border-color: var(--accent-color); color: white;" id="addPublicationBtn">
            <i class="fas fa-plus-circle me-2"></i>Adicionar Nova Publicação
        </button>
    </div>

    <!-- Formulário de Adicionar/Editar Publicação (Inicialmente oculto) -->
    <div class="card p-4 shadow-sm mb-4" id="publicationFormCard" style="display: none;">
        <h5><span id="formTitle">Adicionar</span> Publicação</h5>
        <form id="publicationForm" enctype="multipart/form-data"> {# IMPORTANTE: Adicionado enctype #}
            {% csrf_token %} {# CSRF token é necessário para POST/PUT/DELETE #}
            <input type="hidden" id="publicationId"> {# Para armazenar o ID ao editar #}

            <div class="mb-3">
                <label for="titulo" class="form-label">Título</label>
                <input type="text" class="form-control" id="titulo" name="titulo" required>
            </div>
            <div class="mb-3">
                <label for="autores" class="form-label">Autores</label>
                <input type="text" class="form-control" id="autores" name="autores" required>
            </div>
            <div class="mb-3">
                <label for="ano" class="form-label">Ano</label>
                <input type="number" class="form-control" id="ano" name="ano" required>
            </div>
            <div class="mb-3">
                <label for="publicado_no" class="form-label">Publicado em (Ex: Revista X, Editora Y)</label>
                <input type="text" class="form-control" id="publicado_no" name="publicado_no" required>
            </div>
            <div class="mb-3">
                <label for="categoria" class="form-label">Categoria</label>
                <select class="form-select" id="categoria" name="categoria" required>
                    <option value="">Selecione a Categoria</option>
                    <option value="Artigo">Artigo</option>
                    <option value="Livro">Livro</option>
                    <option value="Capitulo">Capítulo</option>
                    <option value="Conferencia">Conferência</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="descricao" class="form-label">Descrição (Opcional)</label>
                <textarea class="form-control" id="descricao" name="descricao" rows="3"></textarea>
            </div>
            <div class="mb-3">
                <label for="link" class="form-label">Link da Publicação</label>
                <input type="url" class="form-control" id="link" name="link" required>
            </div>
            <div class="mb-3">
                <label for="arquivo" class="form-label">Arquivo PDF (selecione um arquivo)</label>
                <input type="file" class="form-control" id="arquivo" name="arquivo" accept=".pdf"> {# IMPORTANTE: Alterado para type="file" #}
                <small class="form-text text-muted" id="currentFileDisplay"></small> {# Para exibir o arquivo atual #}
            </div>

            <button type="submit" class="btn btn-primary" style="background-color: var(--accent-color); border-color: var(--accent-color); color: white;">
                <i class="fas fa-save me-2"></i>Salvar Publicação
            </button>
            <button type="button" class="btn btn-secondary ms-2" id="cancelFormBtn">
                Cancelar
            </button>
        </form>
        <div id="form-feedback" class="mt-3" style="display: none;"></div>
    </div>

    <!-- Tabela de Publicações -->
    <div class="card p-3 shadow-sm">
        <h5>Publicações Atuais</h5>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Título</th>
                        <th>Autores</th>
                        <th>Ano</th>
                        <th>Categoria</th>
                        <th>Arquivo</th> {# Coluna para o arquivo #}
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="publicationsTableBody">
                    <!-- Publicações serão carregadas dinamicamente aqui -->
                    <tr><td colspan="7" class="text-center">Carregando publicações...</td></tr> {# Colspan ajustado #}
                </tbody>
            </table>
        </div>
        <div id="table-feedback" class="mt-3" style="display: none;"></div>
    </div>
</div>

<script>
    // Script específico para Gerenciar Publicações
    console.log('[Script Publicações] Script iniciado.');

    const publicationsApiUrl = '/api/publicacoes/';
    const publicationsTableBody = document.getElementById('publicationsTableBody');
    const addPublicationBtn = document.getElementById('addPublicationBtn');
    const publicationFormCard = document.getElementById('publicationFormCard');
    const publicationForm = document.getElementById('publicationForm');
    const formTitle = document.getElementById('formTitle');
    const publicationIdInput = document.getElementById('publicationId');
    const cancelFormBtn = document.getElementById('cancelFormBtn');
    const formFeedback = document.getElementById('form-feedback');
    const tableFeedback = document.getElementById('table-feedback');

    // Referências aos campos do formulário
    const tituloInput = document.getElementById('titulo');
    const autoresInput = document.getElementById('autores');
    const anoInput = document.getElementById('ano');
    const publicadoNoInput = document.getElementById('publicado_no');
    const categoriaSelect = document.getElementById('categoria');
    const descricaoInput = document.getElementById('descricao');
    const linkInput = document.getElementById('link');
    const arquivoInput = document.getElementById('arquivo'); // Input do tipo file
    const currentFileDisplay = document.getElementById('currentFileDisplay'); // Para exibir o arquivo atual


    let currentEditId = null;

    // --- Funções de Utilitário ---
    function getCsrfToken() {
        const csrfElement = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfElement) {
            return csrfElement.value;
        }
        console.error('[CSRF Token] Elemento csrfmiddlewaretoken não encontrado.');
        return '';
    }

    function showFeedback(element, message, type = 'info') {
        element.textContent = message;
        element.className = `alert alert-${type}`;
        element.style.display = 'block';
        setTimeout(() => {
            if (element) element.style.display = 'none';
        }, 5000);
    }

    function clearForm() {
        console.log('[Formulário] Limpando formulário.');
        publicationForm.reset();
        publicationIdInput.value = '';
        currentEditId = null;
        formTitle.textContent = 'Adicionar';
        publicationFormCard.style.display = 'none';
        formFeedback.style.display = 'none';
        tableFeedback.style.display = 'none';
        currentFileDisplay.innerHTML = ''; // Limpa o display do arquivo
        arquivoInput.value = ''; // Limpa o input file
    }

    // --- Funções de Renderização e Carga de Dados ---
    async function fetchPublications() {
        console.log('[API] Iniciando busca de publicações...');
        publicationsTableBody.innerHTML = '<tr><td colspan="7" class="text-center">Carregando publicações...</td></tr>'; // Colspan ajustado
        try {
            const response = await fetch(publicationsApiUrl);
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Erro HTTP: ${response.status} - ${errorText}`);
            }
            const publications = await response.json();
            console.log('[API] Publicações carregadas:', publications);
            renderPublicationsTable(publications);
        } catch (error) {
            console.error('[API Erro] Erro ao buscar publicações:', error);
            publicationsTableBody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Falha ao carregar publicações. Verifique o console para mais detalhes.</td></tr>'; // Colspan ajustado
            showFeedback(tableFeedback, `Erro ao carregar publicações: ${error.message}`, 'danger');
        }
    }

    function renderPublicationsTable(publications) {
        console.log('[Renderização] Renderizando tabela de publicações.');
        publicationsTableBody.innerHTML = '';
        if (publications.length === 0) {
            publicationsTableBody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhuma publicação encontrada.</td></tr>'; // Colspan ajustado
            return;
        }

        publications.forEach(pub => {
            const row = publicationsTableBody.insertRow();
            // Link para download do arquivo, se existir
            const fileLinkHtml = pub.arquivo ?
                `<a href="${pub.arquivo}" target="_blank" download><i class="fas fa-file-pdf"></i> PDF</a>` :
                'N/A';

            row.innerHTML = `
                <td>${pub.id}</td>
                <td>${pub.titulo}</td>
                <td>${pub.autores}</td>
                <td>${pub.ano}</td>
                <td>${pub.categoria}</td>
                <td>${fileLinkHtml}</td> {# Coluna para o arquivo #}
                <td>
                    <button type="button" class="btn btn-info btn-sm me-2 edit-btn" data-id="${pub.id}">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button type="button" class="btn btn-danger btn-sm delete-btn" data-id="${pub.id}">
                        <i class="fas fa-trash"></i> Remover
                    </button>
                </td>
            `;
        });

        document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', handleEdit));
        document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', handleDelete));
        console.log('[Renderização] Listeners de botões adicionados.');
    }

    // --- Handlers de Eventos do Formulário e Botões ---
    if (addPublicationBtn) {
        addPublicationBtn.addEventListener('click', () => {
            console.log('[Botão Adicionar] Clicado.');
            clearForm();
            publicationFormCard.style.display = 'block';
            tituloInput.focus();
        });
    } else {
        console.warn('[Botão Adicionar] Botão #addPublicationBtn não encontrado ao inicializar script.');
    }

    if (cancelFormBtn) {
        cancelFormBtn.addEventListener('click', clearForm);
    } else {
        console.warn('[Botão Cancelar] Botão #cancelFormBtn não encontrado ao inicializar script.');
    }

    if (publicationForm) {
        publicationForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            console.log('[Formulário] Submissão iniciada (com arquivo).');

            const formData = new FormData(); // Usar FormData para upload de arquivo

            // Adicionar campos de texto ao FormData
            formData.append('titulo', tituloInput.value);
            formData.append('autores', autoresInput.value);
            formData.append('ano', parseInt(anoInput.value));
            formData.append('publicado_no', publicadoNoInput.value);
            formData.append('categoria', categoriaSelect.value);
            formData.append('descricao', descricaoInput.value || '');
            formData.append('link', linkInput.value);

            // Adicionar o arquivo, se selecionado
            if (arquivoInput.files.length > 0) {
                formData.append('arquivo', arquivoInput.files[0]);
                console.log('[Payload] Arquivo selecionado para upload.');
            } else {
                // Se nenhum arquivo novo for selecionado, e estivermos editando,
                // não envie o campo 'arquivo' para manter o existente.
                // Se for criação e não houver arquivo, o campo é 'null' por padrão no modelo.
                console.log('[Payload] Nenhum arquivo novo selecionado.');
            }

            const csrfToken = getCsrfToken();
            if (!csrfToken) {
                showFeedback(formFeedback, 'Erro: CSRF token não encontrado. Verifique se {% csrf_token %} está no HTML.', 'danger');
                console.error('CSRF token é nulo ou vazio.');
                return;
            }
            formData.append('csrfmiddlewaretoken', csrfToken); // Adiciona CSRF ao FormData

            let method = 'POST';
            let url = publicationsApiUrl;

            if (currentEditId) {
                method = 'PUT';
                url += `${currentEditId}/`;
                console.log(`[Requisição] Modo Edição (PUT) para URL: ${url}`);
            } else {
                console.log(`[Requisição] Modo Criação (POST) para URL: ${url}`);
            }

            try {
                showFeedback(formFeedback, 'Salvando publicação...', 'info');
                // IMPORTANTE: NÃO defina 'Content-Type': 'application/json' para FormData
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        // O navegador define Content-Type: multipart/form-data automaticamente com FormData
                        'X-CSRFToken': csrfToken, // CSRF ainda é necessário no header
                    },
                    body: formData, // Envia o FormData
                });

                if (!response.ok) {
                    const errorData = await response.json(); // Tenta ler JSON para erros
                    throw new Error(errorData.detail || `Erro do servidor (${response.status}): ${JSON.stringify(errorData)}`);
                }

                const result = await response.json();
                showFeedback(formFeedback, `Publicação "${result.titulo}" salva com sucesso!`, 'success');
                clearForm();
                fetchPublications();
                console.log('[Formulário] Operação concluída com sucesso.');
            } catch (error) {
                console.error('[Formulário Erro] Erro ao salvar publicação:', error);
                showFeedback(formFeedback, `Erro ao salvar publicação: ${error.message}`, 'danger');
            }
        });
    } else {
        console.warn('[Formulário] Formulário #publicationForm não encontrado ao inicializar script.');
    }

    async function handleEdit(event) {
        const id = event.target.dataset.id;
        console.log(`[Editar] Clicado para ID: ${id}`);
        try {
            const response = await fetch(`${publicationsApiUrl}${id}`);
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Publicação ${id} não encontrada ou erro HTTP: ${response.status} - ${errorText}`);
            }
            const pub = await response.json();
            console.log('[Editar] Dados da publicação para edição:', pub);

            // Preenche o formulário
            tituloInput.value = pub.titulo;
            autoresInput.value = pub.autores;
            anoInput.value = pub.ano;
            publicadoNoInput.value = pub.publicado_no;
            categoriaSelect.value = pub.categoria;
            descricaoInput.value = pub.descricao || '';
            linkInput.value = pub.link;

            // Lidar com o campo 'arquivo'
            arquivoInput.value = ''; // Limpa o input file para não re-enviar arquivo antigo
            if (pub.arquivo) {
                currentFileDisplay.innerHTML = `Arquivo atual: <a href="${pub.arquivo}" target="_blank">Ver PDF</a>`;
                // Não é possível preencher programaticamente input type="file" por segurança.
                // O usuário terá que selecionar um novo arquivo se quiser alterar.
            } else {
                currentFileDisplay.innerHTML = 'Nenhum arquivo atual.';
            }

            publicationIdInput.value = pub.id;
            currentEditId = pub.id;
            formTitle.textContent = 'Editar';
            publicationFormCard.style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
            console.log('[Editar] Formulário preenchido e exibido.');
        } catch (error) {
            console.error('[Editar Erro] Erro ao buscar publicação para edição:', error);
            showFeedback(tableFeedback, `Erro ao carregar publicação para edição: ${error.message}`, 'danger');
        }
    }

    async function handleDelete(event) {
        const id = event.target.dataset.id;
        console.log(`[Remover] Clicado para ID: ${id}`);
        if (!confirm('Tem certeza que deseja remover esta publicação?')) {
            console.log('[Remover] Operação cancelada pelo utilizador.');
            return;
        }

        try {
            const csrfToken = getCsrfToken();
            if (!csrfToken) {
                showFeedback(tableFeedback, 'Erro: CSRF token não encontrado.', 'danger');
                return;
            }

            const response = await fetch(`${publicationsApiUrl}${id}`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': csrfToken,
                },
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || `Erro do servidor (${response.status}): ${JSON.stringify(errorData)}`);
            }

            showFeedback(tableFeedback, 'Publicação removida com sucesso!', 'success');
            fetchPublications();
            console.log('[Remover] Publicação removida com sucesso.');
        } catch (error) {
            console.error('[Remover Erro] Erro ao remover publicação:', error);
            showFeedback(tableFeedback, `Erro ao remover publicação: ${error.message}`, 'danger');
        }
    }

    // --- Inicialização ---
    fetchPublications();
    console.log('[Script Publicações] Script finalizado.');
</script>

{% endblock content %}
